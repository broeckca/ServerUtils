#!/bin/bash

ARGNUM=2

if [ $# -lt $ARGNUM ]; then
  echo 1>&2 "$0: not enough arguments"
  exit 2
elif [ $# -gt $ARGNUM ]; then
  echo 1>&2 "$0: too many arguments"
  exit 2
fi

echo "-- publishing container $1"
echo "  deleting old image"
lxc image delete $2 2>/dev/null
echo "  stopping container"
lxc stop $1 2>/dev/null
echo "  publishing image"
lxc publish $1 --alias $2
echo "  starting container"
lxc start $1

echo "  exporting image"
lxc image export $2 /data/lxd-templates/$2
echo "  done."
